<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å°è¯´é˜…è¯»å™¨</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #e0e0e0;
            --sidebar-width: 300px;
            --header-height: 60px;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --primary-dark: #3182ce;
            --secondary-color: #2d3748;
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --sidebar-bg: #2d3748;
            --content-bg: #2d3748;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .app-header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        
        [data-theme="dark"] .sidebar-header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        
        [data-theme="dark"] .upload-area {
            background: var(--content-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .upload-area:hover {
            background-color: #374151;
            border-color: var(--primary-dark);
        }
        
        [data-theme="dark"] .chapter-item:hover {
            background: #374151;
        }
        
        [data-theme="dark"] .chapter-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        [data-theme="dark"] .error-message {
            background: #2d1b1b;
            color: #feb2b2;
            border-left-color: #f56565;
        }
        
        /* æ·±è‰²æ¨¡å¼ - ä¾§è¾¹æ å¤´éƒ¨é€‚é… */
        [data-theme="dark"] .sidebar-header {
            background: var(--content-bg);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .book-title {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .book-stats {
            color: #a0aec0;
        }
        
        [data-theme="dark"] .storage-info {
            background: var(--content-bg);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .storage-text {
            color: #a0aec0;
        }
        
        /* æ·±è‰²æ¨¡å¼ - ç« èŠ‚åˆ—è¡¨é€‚é… */
        [data-theme="dark"] .chapter-list {
            background: var(--content-bg);
        }
        
        [data-theme="dark"] .chapter-item {
            border-bottom-color: #4a5568;
            color: var(--text-color);
            background: var(--content-bg);
        }
        
        [data-theme="dark"] .chapter-item:hover {
            background: #374151;
        }
        
        [data-theme="dark"] .chapter-number {
            background: #4a5568;
            color: #e2e8f0;
        }
        
        /* æ·±è‰²æ¨¡å¼ - é˜…è¯»å™¨å·¥å…·æ é€‚é… */
        [data-theme="dark"] .reader-toolbar {
            background: var(--content-bg);
            border-bottom-color: var(--border-color);
        }
        
        [data-theme="dark"] .sidebar-toggle {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .sidebar-toggle:hover {
            background: #374151;
        }
        
        [data-theme="dark"] .font-btn {
            background: var(--content-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .font-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        [data-theme="dark"] .font-size-display {
            color: #a0aec0;
        }
        
        /* æ·±è‰²æ¨¡å¼ - å†…å®¹åŒºåŸŸé€‚é… */
        [data-theme="dark"] .reader-content {
            background: var(--content-bg);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .content-title {
            color: var(--text-color);
            border-bottom-color: var(--border-color);
        }
        
        [data-theme="dark"] .content-text {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .content-paragraph {
            color: var(--text-color);
        }
        
        /* æ·±è‰²æ¨¡å¼ - å­˜å‚¨ç®¡ç†é¢æ¿é€‚é… */
        [data-theme="dark"] .storage-panel {
            background: var(--content-bg);
        }
        
        [data-theme="dark"] .panel-header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-bottom-color: var(--border-color);
        }
        
        [data-theme="dark"] .book-item {
            background: var(--content-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .book-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .book-item-title {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .book-item-info {
            color: #a0aec0;
        }
        
        [data-theme="dark"] .book-item-size {
            color: #718096;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .app-header {
            height: var(--header-height);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            margin-top: var(--header-height);
            flex: 1;
            display: flex;
            position: relative;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        /* å½“åªæœ‰ä¸Šä¼ åŒºåŸŸæ˜¾ç¤ºæ—¶çš„å…¨å±€å±…ä¸­æ ·å¼ */
        .upload-section.upload-only {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1000 !important;
            background: var(--background-color) !important;
            margin: 0 !important;
            padding: 0 !important;
            flex: none !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
        }
        
        /* ç¡®ä¿upload-onlyçŠ¶æ€ä¸‹çš„upload-areaä¹Ÿå±…ä¸­ */
        .upload-section.upload-only .upload-area {
            margin: auto !important;
        }
        
        .upload-area {
            background: white;
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 60px 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-dark);
            background-color: #f8fafc;
            transform: translateY(-2px);
        }
        
        .upload-area.active {
            border-color: #2ecc71;
            background-color: #eafaf1;
        }
        
        .upload-icon {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .upload-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-desc {
            color: #666;
            margin-bottom: 30px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: var(--shadow);
            position: fixed;
            top: var(--header-height);
            left: -var(--sidebar-width);
            bottom: 0;
            transition: var(--transition);
            z-index: 900;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }
        
        .book-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .book-stats {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* å­˜å‚¨ç®¡ç†æ ·å¼ */
        .storage-info {
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }
        
        .storage-usage {
            margin-bottom: 10px;
        }
        
        .storage-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .storage-text {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .btn-small:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        
        /* ä¹¦ç±ç®¡ç†é¢æ¿ */
        .storage-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .books-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .book-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background: white;
            transition: var(--transition);
        }
        
        .book-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .book-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .book-item-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
            flex: 1;
            margin-right: 10px;
            word-break: break-word;
        }
        
        .book-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-tiny {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }
        
        .btn-load {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-load:hover {
            background: #0056b3;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .book-item-info {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .book-item-size {
            font-size: 11px;
            color: #999;
        }
        
        .chapter-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .chapter-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chapter-item:hover {
            background: #f8f9fa;
        }
        
        .chapter-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .chapter-number {
            font-size: 12px;
            background: #e9ecef;
            color: #666;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 30px;
            text-align: center;
        }
        
        .chapter-item.active .chapter-number {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .chapter-title {
            flex: 1;
            font-size: 14px;
            word-break: break-word;
        }
        
        /* é˜…è¯»å™¨å†…å®¹åŒºåŸŸ */
        .reader-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }
        
        .reader-container.with-sidebar {
            margin-left: var(--sidebar-width);
        }
        
        .reader-toolbar {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        .sidebar-toggle:hover {
            background: var(--background-color);
        }
        
        .chapter-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .font-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .font-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .font-size-display {
            font-size: 14px;
            color: #666;
            min-width: 40px;
            text-align: center;
        }
        
        .reader-content {
            flex: 1;
            padding: 40px 40px 100px 40px; /* å¢åŠ åº•éƒ¨è¾¹è·ä¸º100pxï¼Œä¸ºå›ºå®šå¯¼èˆªæ¡ç•™å‡ºç©ºé—´ */
            background: white;
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .content-title {
            font-size: 28px;
            margin-bottom: 30px;
            color: var(--secondary-color);
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            word-break: break-word;
        }
        
        .content-text {
            text-indent: 2em;
            margin-bottom: 1.5em;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .content-paragraph {
            line-height: 1.8;
            margin: 0 0 1em 0;
            text-indent: 2em;
            color: var(--text-color);
            text-align: justify;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .paragraph-break {
            height: 0.5em;
            margin: 0.5em 0;
        }
        
        /* å¤„ç†ä¸­çŠ¶æ€ */
        .processing {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            z-index: 1100;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px;
            display: none;
            border-left: 4px solid #e74c3c;
        }
        
        /* é®ç½©å±‚ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 800;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* åº”ç”¨åŠ¨ç”» */
        .upload-section {
            animation: fadeIn 0.6s ease-out;
        }
        
        .reader-container {
            animation: fadeIn 0.8s ease-out;
        }
        
        .sidebar.open {
            animation: slideInLeft 0.3s ease-out;
        }
        
        .content-text {
            animation: fadeIn 0.4s ease-out;
        }
        
        .chapter-item:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        /* æ”¹è¿›çš„æ»šåŠ¨æ¡æ ·å¼ */
        .reader-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .reader-content::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: 4px;
        }
        
        .reader-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .reader-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-color);
        }
        
        .chapter-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chapter-list::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: 3px;
        }
        
        .chapter-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        /* æ”¹è¿›çš„ç„¦ç‚¹æ ·å¼ */
        .btn:focus,
        .font-btn:focus,
        .sidebar-toggle:focus,
        .theme-toggle:focus,
        .chapter-item:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* æ”¹è¿›çš„é€‰æ‹©æ ·å¼ */
        ::selection {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* å›ºå®šåº•éƒ¨å¯¼èˆªæ¡ */
        .fixed-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            padding: 12px 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        .nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            min-width: 80px;
            justify-content: center;
        }
        
        .nav-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .nav-btn:active {
            transform: translateY(0);
        }
        
        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .nav-icon {
            font-size: 12px;
        }
        
        .chapter-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: var(--text-color);
            min-width: 100px;
        }
        
        .current-chapter {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .total-chapters {
            color: #666;
            font-size: 11px;
        }
        
        /* æš—è‰²ä¸»é¢˜ä¸‹çš„å›ºå®šå¯¼èˆªæ¡ */
        [data-theme="dark"] .fixed-nav {
            background: rgba(45, 45, 45, 0.95);
            border-top-color: #555;
        }
        
        [data-theme="dark"] .chapter-info {
            color: #e0e0e0;
        }
        
        [data-theme="dark"] .total-chapters {
            color: #aaa;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100vw;
                --header-height: 56px;
            }
            
            .app-header {
                padding: 0 15px;
                height: var(--header-height);
            }
            
            .app-title {
                font-size: 18px;
            }
            
            .header-controls {
                gap: 10px;
            }
            
            .theme-toggle {
                padding: 6px;
                font-size: 18px;
            }
            
            .upload-area {
                padding: 40px 20px;
                margin: 20px;
            }
            
            .upload-icon {
                font-size: 48px;
            }
            
            .upload-title {
                font-size: 20px;
            }
            
            .sidebar {
                width: 100vw;
                left: -100vw;
            }
            
            .reader-container.with-sidebar {
                margin-left: 0;
            }
            
            .reader-toolbar {
                flex-wrap: wrap;
                padding: 10px 15px;
                gap: 8px;
            }
            
            .toolbar-left,
            .toolbar-right {
                flex: 1;
                min-width: 200px;
                justify-content: space-between;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
                min-height: 44px; /* è§¦æ‘¸å‹å¥½çš„æœ€å°é«˜åº¦ */
            }
            
            .font-btn {
                min-width: 44px;
                min-height: 44px;
                font-size: 16px;
            }
            
            .reader-content {
                padding: 20px 15px 120px 15px; /* ç§»åŠ¨ç«¯å¢åŠ æ›´å¤šåº•éƒ¨è¾¹è· */
                font-size: 16px;
                line-height: 1.8;
            }
            
            /* ç§»åŠ¨ç«¯å›ºå®šå¯¼èˆªæ¡è°ƒæ•´ */
            .fixed-nav {
                padding: 15px 20px;
            }
            
            .nav-btn {
                padding: 12px 16px;
                font-size: 16px;
                min-height: 48px; /* è§¦æ‘¸å‹å¥½çš„é«˜åº¦ */
                min-width: 90px;
            }
            
            .chapter-info {
                min-width: 120px;
                font-size: 14px;
            }
            
            .content-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .content-paragraph {
                font-size: 16px;
                line-height: 1.8;
                margin-bottom: 1.2em;
            }
            
            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ ä¼˜åŒ– */
            .sidebar-header {
                padding: 15px;
            }
            
            .chapter-item {
                padding: 15px 20px;
                font-size: 16px;
                min-height: 50px;
                display: flex;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            .upload-area {
                padding: 30px 15px;
            }
            
            .reader-content {
                padding: 15px 15px 130px 15px; /* å°å±å¹•éœ€è¦æ›´å¤šåº•éƒ¨è¾¹è· */
            }
            
            .content-title {
                font-size: 20px;
            }
            
            .content-text {
                font-size: 14px;
                line-height: 1.7;
            }
        }
        
        /* é«˜åˆ†è¾¨ç‡å±å¹•ä¼˜åŒ– */
        @media (min-width: 1200px) {
            .reader-content {
                max-width: 900px;
                padding: 60px;
            }
            
            .content-text {
                font-size: 20px;
                line-height: 1.9;
            }
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            .app-header,
            .sidebar,
            .overlay,
            .reader-toolbar {
                display: none !important;
            }
            
            .reader-container {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .reader-content {
                padding: 0 !important;
                overflow: visible !important;
                max-width: none !important;
            }
            
            .content-text {
                color: black !important;
                font-size: 12pt !important;
                line-height: 1.5 !important;
                margin-bottom: 0.5em !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <header class="app-header">
            <div class="app-title">ğŸ“š æ™ºèƒ½å°è¯´é˜…è¯»å™¨</div>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <section class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“š</div>
                    <h2 class="upload-title">ä¸Šä¼ å°è¯´æ–‡ä»¶</h2>
                    <p class="upload-desc">æ‹–æ”¾TXTå°è¯´æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ <br>æ”¯æŒ20MBä»¥å†…çš„TXTæ–‡ä»¶</p>
                    <input type="file" id="fileInput" class="file-input" accept=".txt">
                    <button class="btn" id="uploadBtn">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </section>

            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="book-title" id="bookTitle">å°è¯´æ ‡é¢˜</div>
                    <div class="book-stats" id="bookStats">å…±0ç« ï¼Œçº¦0åƒå­—</div>
                    
                    <!-- å­˜å‚¨ç®¡ç† -->
                    <div class="storage-info" id="storageInfo">
                        <div class="storage-usage">
                            <div class="storage-bar">
                                <div class="storage-fill" id="storageFill"></div>
                            </div>
                            <div class="storage-text" id="storageText">å­˜å‚¨: 0MB / 100MB</div>
                        </div>
                        <button class="btn btn-small" id="storageManageBtn">ç®¡ç†ä¹¦ç±</button>
                        <button class="btn btn-small" id="uploadNewBtn">ä¸Šä¼ æ–°ä¹¦</button>
                    </div>
                </div>
                
                <!-- ä¹¦ç±ç®¡ç†é¢æ¿ -->
                <div class="storage-panel" id="storagePanel" style="display: none;">
                    <div class="panel-header">
                        <h3>å·²ä¿å­˜çš„ä¹¦ç±</h3>
                        <button class="btn btn-small" id="closePanelBtn">è¿”å›</button>
                    </div>
                    <div class="books-list" id="booksList">
                        <!-- ä¹¦ç±åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="chapter-list" id="chapterList">
                    <!-- ç« èŠ‚åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </aside>

            <!-- é˜…è¯»å™¨ -->
            <section class="reader-container" id="readerContainer">
                <div class="reader-toolbar">
                    <div class="toolbar-left">
                        <button class="sidebar-toggle" id="sidebarToggle" title="æ˜¾ç¤º/éšè—ç›®å½•">ğŸ“‹</button>
                    </div>
                    <div class="toolbar-right">
                        <div class="font-controls">
                            <button class="font-btn" id="fontSizeDown" title="å‡å°å­—ä½“">A-</button>
                            <span class="font-size-display" id="fontSizeDisplay">18px</span>
                            <button class="font-btn" id="fontSizeUp" title="å¢å¤§å­—ä½“">A+</button>
                        </div>
                    </div>
                </div>
                <div class="reader-content" id="readerContent">
                    <h1 class="content-title" id="contentTitle">æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å°è¯´é˜…è¯»å™¨</h1>
                    <div id="contentText">
                        <div class="content-paragraph">ç‚¹å‡»å·¦ä¸Šè§’çš„ ğŸ“‹ æŒ‰é’®å¯ä»¥æ‰“å¼€/å…³é—­ä¾§è¾¹æ </div>
                        <div class="content-paragraph">åœ¨ä¾§è¾¹æ ä¸­å¯ä»¥ä¸Šä¼ TXTæ–‡ä»¶å¼€å§‹é˜…è¯»</div>
                        <div class="content-paragraph">æ”¯æŒç« èŠ‚å¯¼èˆªã€ä¸»é¢˜åˆ‡æ¢ã€å­—ä½“å¤§å°è°ƒèŠ‚ç­‰åŠŸèƒ½</div>
                    </div>
                </div>
            </section>
        </main>

        <!-- å›ºå®šåº•éƒ¨å¯¼èˆªæ¡ -->
        <div class="fixed-nav" id="fixedNav">
            <button class="nav-btn" id="fixedPrevBtn" title="ä¸Šä¸€ç« ">
                <span class="nav-icon">â—€</span>
                <span class="nav-text">ä¸Šä¸€ç« </span>
            </button>
            <div class="chapter-info" id="chapterInfo">
                <span class="current-chapter">ç¬¬1ç« </span>
                <span class="total-chapters">/ å…±10ç« </span>
            </div>
            <button class="nav-btn" id="fixedNextBtn" title="ä¸‹ä¸€ç« ">
                <span class="nav-text">ä¸‹ä¸€ç« </span>
                <span class="nav-icon">â–¶</span>
            </button>
        </div>

        <!-- é®ç½©å±‚ -->
        <div class="overlay" id="overlay"></div>

        <!-- å¤„ç†ä¸­çŠ¶æ€ -->
        <div class="processing" id="processing">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- é”™è¯¯æ¶ˆæ¯ -->
        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        class NovelReader {
            constructor() {
                this.novelData = {
                    title: '',
                    chapters: [],
                    currentChapter: 0
                };
                
                this.currentBookId = null;
                
                this.settings = {
                    fontSize: 18,
                    theme: 'light',
                    sidebarOpen: false
                };
                
                // å­˜å‚¨ç®¡ç†
                this.storage = {
                    maxSize: 100 * 1024 * 1024, // 100MB
                    keyPrefix: 'novelReader_',
                    booksKey: 'novelReader_books',
                    progressKey: 'novelReader_progress',
                    settingsKey: 'novelReader_settings'
                };
                
                this.initElements();
                this.initEventListeners();
                this.loadSettings();
                this.loadStoredBooks();
                
                // è®¾ç½®å…¨å±€å¼•ç”¨ï¼Œä¾›HTMLä¸­çš„onclickä½¿ç”¨
                window.novelReader = this;
                
                // åˆå§‹åŒ–å­˜å‚¨æ˜¾ç¤º
                this.updateStorageDisplay();
            }
            
            initElements() {
                // è·å–DOMå…ƒç´ 
                this.uploadSection = document.getElementById('uploadSection');
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.processing = document.getElementById('processing');
                this.errorMessage = document.getElementById('errorMessage');
                
                this.sidebar = document.getElementById('sidebar');
                this.overlay = document.getElementById('overlay');
                this.sidebarToggle = document.getElementById('sidebarToggle');
                this.bookTitle = document.getElementById('bookTitle');
                this.bookStats = document.getElementById('bookStats');
                this.chapterList = document.getElementById('chapterList');
                
                this.readerContainer = document.getElementById('readerContainer');
                this.readerContent = document.getElementById('readerContent');
                this.contentTitle = document.getElementById('contentTitle');
                this.contentText = document.getElementById('contentText');
                
                // å›ºå®šå¯¼èˆªæ¡å…ƒç´ 
                this.fixedNav = document.getElementById('fixedNav');
                this.fixedPrevBtn = document.getElementById('fixedPrevBtn');
                this.fixedNextBtn = document.getElementById('fixedNextBtn');
                this.chapterInfo = document.getElementById('chapterInfo');
                
                this.themeToggle = document.getElementById('themeToggle');
                this.fontSizeUp = document.getElementById('fontSizeUp');
                this.fontSizeDown = document.getElementById('fontSizeDown');
                this.fontSizeDisplay = document.getElementById('fontSizeDisplay');
                
                // è®¾ç½®åˆå§‹çŠ¶æ€ï¼šéšè—ä¸åº”è¯¥åœ¨æ²¡æœ‰å°è¯´æ—¶æ˜¾ç¤ºçš„å…ƒç´ 
                this.setInitialState();
                
                // å­˜å‚¨ç®¡ç†ç›¸å…³å…ƒç´ 
                this.storageInfo = document.getElementById('storageInfo');
                this.storageFill = document.getElementById('storageFill');
                this.storageText = document.getElementById('storageText');
                this.storageManageBtn = document.getElementById('storageManageBtn');
                this.uploadNewBtn = document.getElementById('uploadNewBtn');
                this.storagePanel = document.getElementById('storagePanel');
                this.closePanelBtn = document.getElementById('closePanelBtn');
                this.booksList = document.getElementById('booksList');
            }
            
            setInitialState() {
                // åœ¨æ²¡æœ‰å°è¯´å†…å®¹æ—¶ï¼Œéšè—ä¸åº”è¯¥æ˜¾ç¤ºçš„å…ƒç´ 
                this.sidebar.style.display = 'none';
                this.readerContainer.style.display = 'none';
                this.fixedNav.style.display = 'none';
                
                // ç¡®ä¿ä¸Šä¼ åŒºåŸŸæ˜¯æ˜¾ç¤ºçš„å¹¶æ·»åŠ å…¨å±€å±…ä¸­æ ·å¼
                this.uploadSection.style.display = 'block';
                this.uploadSection.classList.add('upload-only');
            }
            
            initEventListeners() {
                // ä¸Šä¼ ç›¸å…³äº‹ä»¶
                this.uploadBtn.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleFile(e.target.files[0]);
                    }
                });
                
                // æ‹–æ”¾åŠŸèƒ½
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('active');
                });
                
                this.uploadArea.addEventListener('dragleave', () => {
                    this.uploadArea.classList.remove('active');
                });
                
                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('active');
                    if (e.dataTransfer.files.length) {
                        this.handleFile(e.dataTransfer.files[0]);
                    }
                });
                
                // ä¾§è¾¹æ ç›¸å…³äº‹ä»¶
                this.sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                this.overlay.addEventListener('click', () => this.closeSidebar());
                
                // å›ºå®šå¯¼èˆªæ¡äº‹ä»¶
                this.fixedPrevBtn.addEventListener('click', () => this.previousChapter());
                this.fixedNextBtn.addEventListener('click', () => this.nextChapter());
                
                // ä¸»é¢˜åˆ‡æ¢
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // å­—ä½“å¤§å°è°ƒèŠ‚
                this.fontSizeUp.addEventListener('click', () => this.adjustFontSize(2));
                this.fontSizeDown.addEventListener('click', () => this.adjustFontSize(-2));
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                
                // å­˜å‚¨ç®¡ç†äº‹ä»¶
                this.storageManageBtn.addEventListener('click', () => this.showStoragePanel());
                this.uploadNewBtn.addEventListener('click', () => this.returnToUpload());
                this.closePanelBtn.addEventListener('click', () => this.hideStoragePanel());
                
                // è§¦æ‘¸æ‰‹åŠ¿å’Œç¿»é¡µåŠŸèƒ½
                this.initTouchGestures();
                this.initScrollPaging();
                
                // çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨
                window.addEventListener('resize', () => this.handleResize());
            }
            
            handleFile(file) {
                // éªŒè¯æ–‡ä»¶
                if (!file.name.toLowerCase().endsWith('.txt')) {
                    this.showError('è¯·ä¸Šä¼ TXTæ ¼å¼çš„æ–‡ä»¶');
                    return;
                }
                
                if (file.size > 20 * 1024 * 1024) {
                    this.showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡20MB');
                    return;
                }
                
                // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
                this.processing.style.display = 'block';
                this.errorMessage.style.display = 'none';
                
                // è¯»å–æ–‡ä»¶
                const reader = new FileReader();
                reader.onload = (e) => this.processNovel(e.target.result, file.name);
                reader.onerror = () => {
                    this.showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                    this.processing.style.display = 'none';
                };
                reader.readAsText(file, 'UTF-8');
            }
            
            processNovel(content, fileName) {
                try {
                    // è®¾ç½®ä¹¦å
                    this.novelData.title = fileName.replace('.txt', '');
                    this.bookTitle.textContent = this.novelData.title;
                    
                    // è¯†åˆ«ç« èŠ‚
                    this.novelData.chapters = this.identifyChapters(content);
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const bookId = this.saveBookToStorage(this.novelData);
                    if (bookId) {
                        this.currentBookId = bookId;
                        console.log('ä¹¦ç±å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                    }
                    
                    // æ›´æ–°UI
                    this.updateChapterList();
                    this.updateStats();
                    this.showChapter(0);
                    
                    // æ˜¾ç¤ºé˜…è¯»å™¨
                    this.uploadSection.style.display = 'none';
                    this.uploadSection.classList.remove('upload-only');
                    this.processing.style.display = 'none';
                    this.readerContainer.style.display = 'block';
                    
                    // æ˜¾ç¤ºå›ºå®šå¯¼èˆªæ¡
                    this.fixedNav.style.display = 'flex';
                    
                    // è‡ªåŠ¨æ‰“å¼€ä¾§è¾¹æ 
                    this.openSidebar();
                    
                } catch (error) {
                    console.error('å¤„ç†å°è¯´æ—¶å‡ºé”™:', error);
                    this.showError('å¤„ç†å°è¯´æ—¶å‡ºé”™: ' + error.message);
                    this.processing.style.display = 'none';
                }
            }
            
            identifyChapters(content) {
                // æ”¹è¿›çš„ç« èŠ‚è¯†åˆ«ç®—æ³•
                const chapterPatterns = [
                    /^ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+[ç« èŠ‚å›]/,
                    /^ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+ç« /,
                    /^ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+å›/,
                    /^[ä¸Šä¸‹å·]?ç¬¬?[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+[ç« èŠ‚å›]/,
                    /^[ä¸Šä¸‹å·]?ç¬¬?[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+ç« /,
                    /^[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+[ã€\.\s]/,
                    /^\d+[ã€\.\s]/,
                    /^[ç¬¬]?[\s]*[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+[\s]*[ç« èŠ‚å›]/
                ];
                
                const chapters = [];
                const lines = content.split('\n');
                const potentialChapters = [];
                
                // æŸ¥æ‰¾ç« èŠ‚æ ‡é¢˜
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.length === 0 || line.length > 50) continue; // è·³è¿‡ç©ºè¡Œå’Œè¿‡é•¿çš„è¡Œ
                    
                    for (const pattern of chapterPatterns) {
                        if (pattern.test(line)) {
                            potentialChapters.push({
                                index: i,
                                title: line
                            });
                            break;
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç« èŠ‚ï¼ŒæŒ‰å›ºå®šé•¿åº¦åˆ†å‰²
                if (potentialChapters.length === 0) {
                    const chunkSize = Math.ceil(lines.length / Math.max(1, Math.floor(lines.length / 100)));
                    for (let i = 0; i < lines.length; i += chunkSize) {
                        const chapterLines = lines.slice(i, i + chunkSize);
                        const chapterContent = chapterLines.join('\n').trim();
                        if (chapterContent) {
                            chapters.push({
                                title: `ç¬¬${chapters.length + 1}éƒ¨åˆ†`,
                                content: chapterContent
                            });
                        }
                    }
                    return chapters;
                }
                
                // æ ¹æ®ç« èŠ‚ä½ç½®åˆ†å‰²å†…å®¹
                for (let i = 0; i < potentialChapters.length; i++) {
                    const chapterStart = potentialChapters[i].index;
                    const chapterEnd = (i < potentialChapters.length - 1) 
                        ? potentialChapters[i + 1].index 
                        : lines.length;
                    
                    const chapterLines = lines.slice(chapterStart, chapterEnd);
                    const chapterContent = chapterLines.join('\n').trim();
                    
                    if (chapterContent) {
                        chapters.push({
                            title: potentialChapters[i].title,
                            content: chapterContent
                        });
                    }
                }
                
                return chapters;
            }
            
            updateChapterList() {
                this.chapterList.innerHTML = '';
                
                this.novelData.chapters.forEach((chapter, index) => {
                    const item = document.createElement('div');
                    item.className = 'chapter-item';
                    item.innerHTML = `
                        <span class="chapter-number">${index + 1}</span>
                        <span class="chapter-title">${chapter.title}</span>
                    `;
                    item.addEventListener('click', () => {
                        this.showChapter(index);
                        if (window.innerWidth <= 768) {
                            this.closeSidebar();
                        }
                    });
                    this.chapterList.appendChild(item);
                });
            }
            
            updateStats() {
                const totalChapters = this.novelData.chapters.length;
                const totalChars = this.novelData.chapters.reduce((sum, chapter) => 
                    sum + chapter.content.length, 0);
                
                this.bookStats.textContent = `å…±${totalChapters}ç« ï¼Œçº¦${Math.round(totalChars / 1000)}åƒå­—`;
            }
            
            showChapter(index) {
                if (index < 0 || index >= this.novelData.chapters.length) {
                    return;
                }
                
                this.novelData.currentChapter = index;
                const chapter = this.novelData.chapters[index];
                
                // æ›´æ–°æ´»åŠ¨ç« èŠ‚
                document.querySelectorAll('.chapter-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
                
                // æ›´æ–°å†…å®¹
                this.contentTitle.textContent = chapter.title;
                this.contentText.innerHTML = this.formatChapterContent(chapter.content);
                
                // æ›´æ–°å›ºå®šå¯¼èˆªæ¡æŒ‰é’®çŠ¶æ€å’Œç« èŠ‚ä¿¡æ¯
                this.fixedPrevBtn.disabled = index === 0;
                this.fixedNextBtn.disabled = index === this.novelData.chapters.length - 1;
                
                // æ›´æ–°ç« èŠ‚ä¿¡æ¯æ˜¾ç¤º
                const currentChapterSpan = this.chapterInfo.querySelector('.current-chapter');
                const totalChaptersSpan = this.chapterInfo.querySelector('.total-chapters');
                if (currentChapterSpan && totalChaptersSpan) {
                    currentChapterSpan.textContent = `ç¬¬${index + 1}ç« `;
                    totalChaptersSpan.textContent = `/ å…±${this.novelData.chapters.length}ç« `;
                }
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨ - ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°å®Œæˆ
                setTimeout(() => {
                    this.readerContent.scrollTop = 0;
                }, 10);
                
                // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°è®¾ç½®
                this.saveSettings();
                
                // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
                if (this.currentBookId) {
                    this.saveReadingProgress(this.currentBookId, index, 0);
                }
            }
            
            formatChapterContent(content) {
                // å…ˆå¤„ç†è¿ç»­çš„ç©ºè¡Œï¼Œå°†å¤šä¸ªè¿ç»­ç©ºè¡Œåˆå¹¶ä¸ºä¸€ä¸ª
                const normalizedContent = content.replace(/\n\s*\n\s*\n/g, '\n\n');
                const paragraphs = normalizedContent.split('\n');
                let formattedHTML = '';
                
                paragraphs.forEach(para => {
                    const trimmed = para.trim();
                    if (trimmed === '') {
                        // ç©ºè¡Œä½œä¸ºæ®µè½é—´è·
                        formattedHTML += `<div class="paragraph-break"></div>`;
                    } else {
                        // éç©ºè¡Œä½œä¸ºæ®µè½å†…å®¹
                        formattedHTML += `<p class="content-paragraph">${trimmed}</p>`;
                    }
                });
                
                return formattedHTML;
            }
            
            previousChapter() {
                if (this.novelData.currentChapter > 0) {
                    this.showChapter(this.novelData.currentChapter - 1);
                }
            }
            
            nextChapter() {
                if (this.novelData.currentChapter < this.novelData.chapters.length - 1) {
                    this.showChapter(this.novelData.currentChapter + 1);
                }
            }
            
            toggleSidebar() {
                if (this.settings.sidebarOpen) {
                    this.closeSidebar();
                } else {
                    this.openSidebar();
                }
            }
            
            openSidebar() {
                this.settings.sidebarOpen = true;
                this.sidebar.style.display = 'block'; // ç¡®ä¿ä¾§è¾¹æ å¯è§
                this.sidebar.classList.add('open');
                this.overlay.classList.add('show');
                if (window.innerWidth > 768) {
                    this.readerContainer.classList.add('with-sidebar');
                }
                this.saveSettings();
            }
            
            closeSidebar() {
                this.settings.sidebarOpen = false;
                this.sidebar.classList.remove('open');
                this.overlay.classList.remove('show');
                this.readerContainer.classList.remove('with-sidebar');
                this.saveSettings();
            }
            
            handleResize() {
                // åœ¨PCæ¨¡å¼å’Œç§»åŠ¨ç«¯ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œé‡æ–°è¯„ä¼°ä¾§è¾¹æ çŠ¶æ€
                if (window.innerWidth <= 768) {
                    // ç§»åŠ¨ç«¯ï¼šå¦‚æœä¾§è¾¹æ æ˜¯æ‰“å¼€çš„ï¼Œä¿æŒæ‰“å¼€çŠ¶æ€
                    if (this.settings.sidebarOpen) {
                        this.openSidebar();
                    }
                } else {
                    // PCæ¨¡å¼ï¼šç§»é™¤with-sidebarç±»ï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ§åˆ¶
                    if (this.settings.sidebarOpen) {
                        this.readerContainer.classList.add('with-sidebar');
                    } else {
                        this.readerContainer.classList.remove('with-sidebar');
                    }
                }
            }
            
            toggleTheme() {
                this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', this.settings.theme);
                this.themeToggle.textContent = this.settings.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                this.saveSettings();
            }
            
            adjustFontSize(delta) {
                this.settings.fontSize = Math.max(12, Math.min(32, this.settings.fontSize + delta));
                this.readerContent.style.fontSize = this.settings.fontSize + 'px';
                this.fontSizeDisplay.textContent = this.settings.fontSize + 'px';
                this.saveSettings();
            }
            
            initTouchGestures() {
                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let touchEndY = 0;
                
                this.readerContent.addEventListener('touchstart', (e) => {
                    if (!this.novelData || !this.currentBookId) return;
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                
                this.readerContent.addEventListener('touchend', (e) => {
                    if (!this.novelData || !this.currentBookId) return;
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;
                    this.handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
                }, { passive: true });
            }
            
            handleSwipe(startX, startY, endX, endY) {
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                const minSwipeDistance = 50;
                
                // ç¡®ä¿æ°´å¹³æ»‘åŠ¨è·ç¦»å¤§äºå‚ç›´æ»‘åŠ¨è·ç¦»
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // å‘å³æ»‘åŠ¨ - ä¸Šä¸€ç« 
                        this.previousChapter();
                    } else {
                        // å‘å·¦æ»‘åŠ¨ - ä¸‹ä¸€ç« 
                        this.nextChapter();
                    }
                }
            }
            
            initScrollPaging() {
                console.log('åˆå§‹åŒ–æ»šåŠ¨ç¿»é¡µåŠŸèƒ½');
                console.log('readerContentå…ƒç´ :', this.readerContent);
                
                if (!this.readerContent) {
                    console.error('readerContentå…ƒç´ æœªæ‰¾åˆ°ï¼');
                    return;
                }
                
                let scrollTimeout;
                let lastScrollTop = 0;
                let isAutoScrolling = false;
                
                this.readerContent.addEventListener('scroll', (e) => {
                    console.log('æ»šåŠ¨äº‹ä»¶è§¦å‘');
                    
                    if (!this.novelData || !this.currentBookId || isAutoScrolling) {
                        console.log('æ»šåŠ¨è¢«å¿½ç•¥:', { 
                            hasNovelData: !!this.novelData,
                            hasCurrentBookId: !!this.currentBookId,
                            isAutoScrolling 
                        });
                        return;
                    }
                    
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const currentScrollTop = this.readerContent.scrollTop;
                        const scrollHeight = this.readerContent.scrollHeight;
                        const clientHeight = this.readerContent.clientHeight;
                        const bottomThreshold = 20;
                        const topThreshold = 20;
                        
                        const isAtBottom = currentScrollTop + clientHeight >= scrollHeight - bottomThreshold;
                        const isAtTop = currentScrollTop <= topThreshold;
                        
                        console.log('æ»šåŠ¨æ£€æµ‹è¯¦æƒ…:', {
                            currentScrollTop: Math.round(currentScrollTop),
                            scrollHeight: Math.round(scrollHeight),
                            clientHeight: Math.round(clientHeight),
                            bottomDistance: Math.round(scrollHeight - (currentScrollTop + clientHeight)),
                            isAtBottom,
                            isAtTop,
                            hasNextChapter: this.novelData.currentChapter < this.novelData.chapters.length - 1,
                            hasPrevChapter: this.novelData.currentChapter > 0,
                            currentChapter: this.novelData.currentChapter,
                            totalChapters: this.novelData.chapters.length
                        });
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨æ—¶è‡ªåŠ¨ç¿»åˆ°ä¸‹ä¸€ç« 
                        if (isAtBottom && this.novelData.currentChapter < this.novelData.chapters.length - 1) {
                            console.log('ğŸ”„ è§¦å‘ä¸‹ä¸€ç« ç¿»é¡µ');
                            isAutoScrolling = true;
                            setTimeout(() => {
                                this.nextChapter();
                                setTimeout(() => {
                                    isAutoScrolling = false;
                                }, 100);
                            }, 500);
                        }
                        // æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶è‡ªåŠ¨ç¿»åˆ°ä¸Šä¸€ç« 
                        else if (isAtTop && lastScrollTop > currentScrollTop && this.novelData.currentChapter > 0) {
                            console.log('ğŸ”„ è§¦å‘ä¸Šä¸€ç« ç¿»é¡µ');
                            isAutoScrolling = true;
                            setTimeout(() => {
                                this.previousChapter();
                                // æ»šåŠ¨åˆ°æ–°ç« èŠ‚çš„åº•éƒ¨
                                setTimeout(() => {
                                    this.readerContent.scrollTop = this.readerContent.scrollHeight - this.readerContent.clientHeight;
                                    setTimeout(() => {
                                        isAutoScrolling = false;
                                    }, 100);
                                }, 100);
                            }, 500);
                        }
                        
                        lastScrollTop = currentScrollTop;
                        
                        // ä¿å­˜é˜…è¯»è¿›åº¦ï¼ˆæ»šåŠ¨ä½ç½®ï¼‰
                        if (this.currentBookId) {
                            this.saveReadingProgress(this.currentBookId, this.novelData.currentChapter, currentScrollTop);
                        }
                    }, 150);
                }, { passive: true });
                
                console.log('æ»šåŠ¨ç¿»é¡µäº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            }
            
            handleKeyboard(e) {
                if (!this.novelData || !this.currentBookId) return;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.previousChapter();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.nextChapter();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.readerContent.scrollBy(0, -200);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        this.readerContent.scrollBy(0, 200);
                        break;
                    case 'PageUp':
                        e.preventDefault();
                        this.readerContent.scrollBy(0, -this.readerContent.clientHeight * 0.8);
                        break;
                    case 'PageDown':
                        e.preventDefault();
                        this.readerContent.scrollBy(0, this.readerContent.clientHeight * 0.8);
                        break;
                    case 'Home':
                        e.preventDefault();
                        this.readerContent.scrollTop = 0;
                        break;
                    case 'End':
                        e.preventDefault();
                        this.readerContent.scrollTop = this.readerContent.scrollHeight;
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.closeSidebar();
                        break;
                    case 't':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            this.toggleTheme();
                        }
                        break;
                    case 'm':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            this.toggleSidebar();
                        }
                        break;
                }
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                setTimeout(() => {
                    this.errorMessage.style.display = 'none';
                }, 5000);
            }
            
            saveSettings() {
                localStorage.setItem('novelReaderSettings', JSON.stringify({
                    ...this.settings,
                    currentChapter: this.novelData.currentChapter
                }));
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem('novelReaderSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.settings = { ...this.settings, ...settings };
                        
                        // åº”ç”¨è®¾ç½®
                        document.documentElement.setAttribute('data-theme', this.settings.theme);
                        this.themeToggle.textContent = this.settings.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                        this.readerContent.style.fontSize = this.settings.fontSize + 'px';
                        this.fontSizeDisplay.textContent = this.settings.fontSize + 'px';
                    }
                    
                    // æ ¹æ®å±å¹•å®½åº¦è®¾ç½®ä¾§è¾¹æ åˆå§‹çŠ¶æ€
                    // åœ¨PCæ¨¡å¼ä¸‹ï¼ˆå®½åº¦å¤§äº768pxï¼‰ï¼Œä¾§è¾¹æ é»˜è®¤å…³é—­ï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ§åˆ¶
                    if (window.innerWidth > 768) {
                        this.settings.sidebarOpen = false;
                        this.closeSidebar();
                    } else {
                        // ç§»åŠ¨ç«¯ä¿æŒåŸæœ‰é€»è¾‘
                        if (this.settings.sidebarOpen) {
                            this.openSidebar();
                        } else {
                            this.closeSidebar();
                        }
                    }
                } catch (error) {
                    console.warn('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                }
            }
            
            // ===== å­˜å‚¨ç®¡ç†æ–¹æ³• =====
            
            // è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µ
            getStorageUsage() {
                let totalSize = 0;
                const books = this.getStoredBooks();
                
                for (let key in localStorage) {
                    if (key.startsWith(this.storage.keyPrefix)) {
                        totalSize += localStorage.getItem(key).length * 2; // UTF-16ç¼–ç ï¼Œæ¯å­—ç¬¦2å­—èŠ‚
                    }
                }
                
                return {
                    used: totalSize,
                    max: this.storage.maxSize,
                    available: this.storage.maxSize - totalSize,
                    percentage: Math.round((totalSize / this.storage.maxSize) * 100),
                    booksCount: books.length
                };
            }
            
            // æ£€æŸ¥å­˜å‚¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            checkStorageSpace(dataSize) {
                const usage = this.getStorageUsage();
                return usage.available >= dataSize;
            }
            
            // ä¿å­˜å°è¯´åˆ°æœ¬åœ°å­˜å‚¨
            saveBookToStorage(bookData) {
                try {
                    const bookId = this.generateBookId(bookData.title);
                    const bookKey = this.storage.keyPrefix + 'book_' + bookId;
                    const bookJson = JSON.stringify(bookData);
                    const bookSize = bookJson.length * 2;
                    
                    // æ£€æŸ¥å­˜å‚¨ç©ºé—´
                    if (!this.checkStorageSpace(bookSize)) {
                        throw new Error('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†ä¸€äº›ä¹¦ç±åé‡è¯•');
                    }
                    
                    // ä¿å­˜ä¹¦ç±æ•°æ®
                    localStorage.setItem(bookKey, bookJson);
                    
                    // æ›´æ–°ä¹¦ç±åˆ—è¡¨
                    const books = this.getStoredBooks();
                    const existingIndex = books.findIndex(book => book.id === bookId);
                    const bookInfo = {
                        id: bookId,
                        title: bookData.title,
                        chapters: bookData.chapters.length,
                        size: bookSize,
                        savedAt: new Date().toISOString(),
                        lastRead: new Date().toISOString()
                    };
                    
                    if (existingIndex >= 0) {
                        books[existingIndex] = bookInfo;
                    } else {
                        books.push(bookInfo);
                    }
                    
                    localStorage.setItem(this.storage.booksKey, JSON.stringify(books));
                    
                    console.log('ä¹¦ç±ä¿å­˜æˆåŠŸ:', bookData.title);
                    this.updateStorageDisplay();
                    return bookId;
                    
                } catch (error) {
                    console.error('ä¿å­˜ä¹¦ç±å¤±è´¥:', error);
                    this.showError('ä¿å­˜å¤±è´¥: ' + error.message);
                    return null;
                }
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å°è¯´
            loadBookFromStorage(bookId) {
                try {
                    const bookKey = this.storage.keyPrefix + 'book_' + bookId;
                    const bookJson = localStorage.getItem(bookKey);
                    
                    if (!bookJson) {
                        throw new Error('ä¹¦ç±ä¸å­˜åœ¨');
                    }
                    
                    const bookData = JSON.parse(bookJson);
                    
                    // æ›´æ–°æœ€åé˜…è¯»æ—¶é—´
                    this.updateBookLastRead(bookId);
                    
                    return bookData;
                } catch (error) {
                    console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
                    this.showError('åŠ è½½å¤±è´¥: ' + error.message);
                    return null;
                }
            }
            
            // è·å–å·²ä¿å­˜çš„ä¹¦ç±åˆ—è¡¨
            getStoredBooks() {
                try {
                    const booksJson = localStorage.getItem(this.storage.booksKey);
                    return booksJson ? JSON.parse(booksJson) : [];
                } catch (error) {
                    console.error('è·å–ä¹¦ç±åˆ—è¡¨å¤±è´¥:', error);
                    return [];
                }
            }
            
            // åˆ é™¤ä¹¦ç±
            deleteBookFromStorage(bookId) {
                try {
                    const bookKey = this.storage.keyPrefix + 'book_' + bookId;
                    localStorage.removeItem(bookKey);
                    
                    // ä»ä¹¦ç±åˆ—è¡¨ä¸­ç§»é™¤
                    const books = this.getStoredBooks();
                    const filteredBooks = books.filter(book => book.id !== bookId);
                    localStorage.setItem(this.storage.booksKey, JSON.stringify(filteredBooks));
                    
                    // åˆ é™¤ç›¸å…³çš„é˜…è¯»è¿›åº¦
                    const progressKey = this.storage.progressKey + '_' + bookId;
                    localStorage.removeItem(progressKey);
                    
                    console.log('ä¹¦ç±åˆ é™¤æˆåŠŸ:', bookId);
                    this.updateStorageDisplay();
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤ä¹¦ç±å¤±è´¥:', error);
                    this.showError('åˆ é™¤å¤±è´¥: ' + error.message);
                    return false;
                }
            }
            
            // ç”Ÿæˆä¹¦ç±ID
            generateBookId(title) {
                return btoa(encodeURIComponent(title)).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
            }
            
            // æ›´æ–°ä¹¦ç±æœ€åé˜…è¯»æ—¶é—´
            updateBookLastRead(bookId) {
                try {
                    const books = this.getStoredBooks();
                    const bookIndex = books.findIndex(book => book.id === bookId);
                    if (bookIndex >= 0) {
                        books[bookIndex].lastRead = new Date().toISOString();
                        localStorage.setItem(this.storage.booksKey, JSON.stringify(books));
                    }
                } catch (error) {
                    console.error('æ›´æ–°é˜…è¯»æ—¶é—´å¤±è´¥:', error);
                }
            }
            
            // ä¿å­˜é˜…è¯»è¿›åº¦
            saveReadingProgress(bookId, chapter, scrollPosition) {
                try {
                    const progressKey = this.storage.progressKey + '_' + bookId;
                    const progress = {
                        chapter: chapter,
                        scrollPosition: scrollPosition,
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem(progressKey, JSON.stringify(progress));
                } catch (error) {
                    console.error('ä¿å­˜é˜…è¯»è¿›åº¦å¤±è´¥:', error);
                }
            }
            
            // åŠ è½½é˜…è¯»è¿›åº¦
            loadReadingProgress(bookId) {
                try {
                    const progressKey = this.storage.progressKey + '_' + bookId;
                    const progressJson = localStorage.getItem(progressKey);
                    return progressJson ? JSON.parse(progressJson) : null;
                } catch (error) {
                    console.error('åŠ è½½é˜…è¯»è¿›åº¦å¤±è´¥:', error);
                    return null;
                }
            }
            
            // åŠ è½½å·²ä¿å­˜çš„ä¹¦ç±ï¼ˆé¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
            loadStoredBooks() {
                const books = this.getStoredBooks();
                if (books.length > 0) {
                    console.log('å‘ç°å·²ä¿å­˜çš„ä¹¦ç±:', books.length, 'æœ¬');
                    
                    // è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±
                    const lastReadBook = books.reduce((latest, book) => {
                        return new Date(book.lastRead) > new Date(latest.lastRead) ? book : latest;
                    });
                    
                    if (lastReadBook && new Date(lastReadBook.lastRead) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                        // å¦‚æœä¸Šæ¬¡é˜…è¯»æ—¶é—´åœ¨7å¤©å†…ï¼Œè‡ªåŠ¨æ¢å¤
                        console.log('è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡é˜…è¯»çš„ä¹¦ç±:', lastReadBook.title);
                        setTimeout(() => {
                            this.loadStoredBook(lastReadBook.id);
                        }, 100);
                    }
                }
            }
            
            // æ›´æ–°å­˜å‚¨æ˜¾ç¤º
            updateStorageDisplay() {
                const usage = this.getStorageUsage();
                
                // æ›´æ–°å­˜å‚¨æ¡
                this.storageFill.style.width = usage.percentage + '%';
                
                // æ›´æ–°å­˜å‚¨æ–‡æœ¬
                const usedMB = Math.round(usage.used / (1024 * 1024) * 100) / 100;
                const maxMB = Math.round(usage.max / (1024 * 1024));
                this.storageText.textContent = `å­˜å‚¨: ${usedMB}MB / ${maxMB}MB (${usage.booksCount}æœ¬ä¹¦)`;
                
                console.log('å­˜å‚¨ä½¿ç”¨æƒ…å†µ:', usage);
            }
            
            // æ˜¾ç¤ºå­˜å‚¨ç®¡ç†é¢æ¿
            showStoragePanel() {
                this.storagePanel.style.display = 'flex';
                this.chapterList.style.display = 'none';
                this.renderBooksList();
            }
            
            // éšè—å­˜å‚¨ç®¡ç†é¢æ¿
            hideStoragePanel() {
                this.storagePanel.style.display = 'none';
                this.chapterList.style.display = 'block';
            }
            
            // è¿”å›ä¸Šä¼ ç•Œé¢
            returnToUpload() {
                // æ¸…é™¤å½“å‰ä¹¦ç±æ•°æ®
                this.currentBook = null;
                this.currentChapter = 0;
                this.chapters = [];
                
                // é‡ç½®ç•Œé¢åˆ°åˆå§‹çŠ¶æ€
                this.setInitialState();
                
                // æ¸…ç©ºå†…å®¹
                this.bookTitle.textContent = 'å°è¯´æ ‡é¢˜';
                this.bookStats.textContent = 'å…±0ç« ï¼Œçº¦0åƒå­—';
                this.chapterList.innerHTML = '';
                this.readerContent.innerHTML = '';
                this.contentTitle.textContent = '';
                this.contentText.textContent = '';
                
                // å…³é—­ä¾§è¾¹æ 
                this.closeSidebar();
            }
            
            // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
            renderBooksList() {
                const books = this.getStoredBooks();
                
                if (books.length === 0) {
                    this.booksList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>æš‚æ— ä¿å­˜çš„ä¹¦ç±</p>
                            <p style="font-size: 12px;">ä¸Šä¼ å°è¯´æ–‡ä»¶åä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°</p>
                        </div>
                    `;
                    return;
                }
                
                // æŒ‰æœ€åé˜…è¯»æ—¶é—´æ’åº
                books.sort((a, b) => new Date(b.lastRead) - new Date(a.lastRead));
                
                this.booksList.innerHTML = books.map(book => {
                    const sizeMB = Math.round(book.size / (1024 * 1024) * 100) / 100;
                    const lastRead = new Date(book.lastRead).toLocaleDateString('zh-CN');
                    
                    return `
                        <div class="book-item" data-book-id="${book.id}">
                            <div class="book-item-header">
                                <div class="book-item-title">${book.title}</div>
                                <div class="book-item-actions">
                                    <button class="btn-tiny btn-load" onclick="novelReader.loadStoredBook('${book.id}')">é˜…è¯»</button>
                                    <button class="btn-tiny btn-delete" onclick="novelReader.confirmDeleteBook('${book.id}', '${book.title}')">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="book-item-info">
                                <span>${book.chapters}ç« </span>
                                <span>æœ€åé˜…è¯»: ${lastRead}</span>
                            </div>
                            <div class="book-item-size">${sizeMB}MB</div>
                        </div>
                    `;
                }).join('');
            }
            
            // åŠ è½½å·²ä¿å­˜çš„ä¹¦ç±
            loadStoredBook(bookId) {
                const bookData = this.loadBookFromStorage(bookId);
                if (!bookData) {
                    return;
                }
                
                // è®¾ç½®å½“å‰ä¹¦ç±æ•°æ®
                this.novelData = bookData;
                this.currentBookId = bookId;
                
                // æ›´æ–°UI
                this.bookTitle.textContent = bookData.title;
                this.updateChapterList();
                this.updateStats();
                
                // åŠ è½½é˜…è¯»è¿›åº¦
                const progress = this.loadReadingProgress(bookId);
                const startChapter = progress ? progress.chapter : 0;
                this.showChapter(startChapter);
                
                // å¦‚æœæœ‰ä¿å­˜çš„æ»šåŠ¨ä½ç½®ï¼Œæ¢å¤å®ƒ
                if (progress && progress.scrollPosition) {
                    setTimeout(() => {
                        this.readerContent.scrollTop = progress.scrollPosition;
                    }, 100);
                }
                
                // æ˜¾ç¤ºé˜…è¯»å™¨
                this.uploadSection.style.display = 'none';
                this.uploadSection.classList.remove('upload-only');
                this.readerContainer.style.display = 'block';
                
                // æ˜¾ç¤ºå›ºå®šå¯¼èˆªæ¡
                this.fixedNav.style.display = 'flex';
                
                // æ˜¾ç¤ºä¾§è¾¹æ 
                this.sidebar.style.display = 'block';
                
                // éšè—å­˜å‚¨é¢æ¿
                this.hideStoragePanel();
                
                console.log('å·²åŠ è½½ä¹¦ç±:', bookData.title);
            }
            
            // ç¡®è®¤åˆ é™¤ä¹¦ç±
            confirmDeleteBook(bookId, title) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                    this.deleteBookFromStorage(bookId);
                    this.renderBooksList();
                }
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new NovelReader();
        });
    </script>
</body>
</html>